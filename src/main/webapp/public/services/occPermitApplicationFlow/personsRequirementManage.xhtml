<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">
    <h:head>
        <h:outputStylesheet name="css/style.css"/>
        <title>TCVCOG Code Enforcement Home</title>
    </h:head>
    <h:body>
        <ui:composition template="./../../navContainer_public.xhtml">

            <ui:define name="content">
                <f:view id="sysHomeView">

                    <div class="mainContainer">

                        <h:form id="messageForm">
                            <h:messages globalOnly="true" showDetail="true" showSummary="true"
                                        warnClass="msgWarn" infoClass="msgInfo" fatalClass="msgFatal" errorClass="msgError"/>
                        </h:form>

                        <h:form id="personsRequirementManageForm">

                            <h1>Step 5/5: Add People to Application</h1>

                            <p:panel>
                                <h3>Step 1: Select Property</h3>

                                <p:outputLabel>Chosen property:</p:outputLabel>

                                <p:dataTable
                                    id="chosenPropertyTable"
                                    var="prop" 
                                    value="#{occPermitApplicationBB.prop.bundledProperty}"
                                    rowKey="#{prop.propertyID}">

                                    <p:column>
                                        <f:facet name="header">
                                            <h:outputText value="Address" />
                                        </f:facet>
                                        <h:outputText value="#{prop.address}"/>
                                    </p:column>


                                    <p:column>

                                        <f:facet name="header">
                                            <h:outputText value="Type" />
                                        </f:facet>
                                        <h:outputText value="#{prop.useType.name}"/>

                                    </p:column>

                                </p:dataTable>

                            </p:panel>

                            <p:panel>
                                <h3>Step 2: Configure Unit List</h3>
                                <p:outputLabel>Configured Unit List:</p:outputLabel>
                                <p:dataTable
                                    id="configuredUnitTable"
                                    var="unit"
                                    value="#{occPermitApplicationBB.workingPropUnits}"
                                    rowKey="#{unit.bundledUnit.unitID}"
                                    >                                         

                                    <p:column>
                                        <f:facet name="header">
                                            <h:outputText value="Unit Number" />
                                        </f:facet>
                                        <h:outputText value="#{unit.bundledUnit.unitNumber}" />
                                    </p:column>

                                    <p:column>
                                        <f:facet name="header">
                                            <h:outputText value="Rental Notes" />
                                        </f:facet>
                                        <h:outputText value="#{unit.bundledUnit.rentalNotes}" />
                                    </p:column>

                                    <p:column>
                                        <f:facet name="header">
                                            <h:outputText value="Unit Description" />
                                        </f:facet>
                                        <h:outputText value="#{unit.bundledUnit.notes}" />
                                    </p:column>

                                </p:dataTable>
                            </p:panel>

                            <p:panel>
                                <h3>Step 3: Select Units For Application</h3>

                                <p:outputLabel>Chosen Unit:</p:outputLabel>

                                <p:dataTable
                                    id="chosenUnitTable"
                                    var="unit"
                                    value="#{occPermitApplicationBB.selectedUnit.bundledUnit}"
                                    rowKey="#{unit.unitID}"
                                    >                                         

                                    <p:column>
                                        <f:facet name="header">
                                            <h:outputText value="Unit Number" />
                                        </f:facet>
                                        <h:outputText value="#{unit.unitNumber}" />
                                    </p:column>

                                    <p:column>
                                        <f:facet name="header">
                                            <h:outputText value="Rental Notes" />
                                        </f:facet>
                                        <h:outputText value="#{unit.rentalNotes}" />
                                    </p:column>

                                    <p:column>
                                        <f:facet name="header">
                                            <h:outputText value="Unit Description" />
                                        </f:facet>
                                        <h:outputText value="#{unit.notes}" />
                                    </p:column>

                                </p:dataTable>
                            </p:panel>

                            <p:spacer height="5px" />
                            <p:panel>
                                <h3>Step 4: Choose Reason For Application</h3>

                                <p:outputLabel value="The selected reason for the application is: #{occPermitApplicationBB.currentApplication.reason.title}"/>

                                <p:spacer height="5px"/>

                                <p:outputLabel value="Your attached notes: #{occPermitApplicationBB.currentApplication.submissionNotes}"/>
                            </p:panel>

                            <p:spacer height="5px"/>

                            <h2 id="currentStep">Step 5: Add People To Application</h2>

                            <p:outputLabel value="#{occPermitApplicationBB.currentApplication.reason.humanFriendlyDescription}"/>

                            <b>Remember to hit the enter key when you finish filling out a box!</b>
                            
                            <h:panelGrid id="menu" columns="1" cellpadding="10" columnClasses="gridTd-solid-back" style="width:100%">
                                <h:panelGroup >
                                    <h:panelGrid columns="4" cellpadding="10" footerClass="gridFooter">
                                        <h:panelGroup>
                                            <p:outputLabel id="last-name-ol" value="Filter by last name" />
                                        </h:panelGroup>
                                        <h:panelGroup>
                                            <p:inputText id="last-name-it" value="#{occPermitApplicationBB.searchPerson.lastName}"/>
                                        </h:panelGroup>

                                        <h:panelGroup>
                                            <p:outputLabel id="first-name-ol" value="Filter by first name" />
                                        </h:panelGroup>
                                        <h:panelGroup>
                                            <p:inputText id="first-name-it" value="#{occPermitApplicationBB.searchPerson.firstName}"/>
                                        </h:panelGroup>

                                        <h:panelGroup>
                                            <p:outputLabel id="email-ol" value="Filter by email" />
                                        </h:panelGroup>
                                        <h:panelGroup>
                                            <p:inputText id="email-it" value="#{occPermitApplicationBB.searchPerson.email}"/>
                                        </h:panelGroup>

                                        <h:panelGroup>
                                            <p:outputLabel id="phone-number-ol" value="Filter by phone?" />
                                        </h:panelGroup>
                                        <h:panelGroup>
                                            <p:inputText id="phone-number-it" value="#{occPermitApplicationBB.searchPerson.phoneCell}"/>
                                        </h:panelGroup>

                                        <h:panelGroup>
                                            <p:outputLabel id="street-ol" value="Filter by street?" />
                                        </h:panelGroup>                                        
                                        <h:panelGroup>
                                            <p:inputText id="street-it" value="#{occPermitApplicationBB.searchPerson.addressStreet}"/>
                                        </h:panelGroup>

                                    </h:panelGrid>
                                    <p:commandButton value= "Search" action="#{occPermitApplicationBB.searchForPersons()}" 
                                                     update="results-dt" ajax="true"/>


                                    <p:dataTable id="results-dt" 
                                                 var="person" 
                                                 value="#{occPermitApplicationBB.personSearchResults}" 
                                                 scrollable="true" scrollHeight="300">
                                        <p:column headerText="Last Name">
                                            <h:outputText value="#{person.bundledPerson.lastName}" />
                                        </p:column>

                                        <p:column headerText="First Name">
                                            <h:outputText value="#{person.bundledPerson.firstName}" />
                                        </p:column>

                                        <p:column headerText="Street Address">
                                            <h:outputText value="#{person.bundledPerson.addressStreet}" />
                                        </p:column>

                                        <p:column headerText="Home Phone">
                                            <h:outputText value="#{person.bundledPerson.phoneHome}" />
                                        </p:column>

                                        <p:column headerText="Cell Phone">
                                            <h:outputText value="#{person.bundledPerson.phoneCell}" />
                                        </p:column>

                                        <p:column headerText="Work Phone">
                                            <h:outputText value="#{person.bundledPerson.phoneWork}" />
                                        </p:column>

                                        <p:column headerText="Email">
                                            <h:outputText value="#{person.bundledPerson.email}" />
                                        </p:column>

                                        <p:column>
                                            <p:commandButton ajax="true" 
                                                             update=":personsRequirementManageForm:applicationPersonTable
                                                             :messageForm" 
                                                             action="#{occPermitApplicationBB.addPersonToApplication(person)}" 
                                                             id="attach-person-cb" value="Attach" />
                                        </p:column>

                                    </p:dataTable>
                                </h:panelGroup>
                            </h:panelGrid>
                            <p:outputLabel> Can't find the person you are looking for? Add a person to the table below and press the pencil to enter their information.
                                            Click the arrow button below the pencil to fill in more of their contact information.
                                            </p:outputLabel> 

                            <p:spacer height="10px"/>

                            <p:outputLabel value="#{occPermitApplicationBB.personRequirementDescription.get(0)}"/>

                            <p:spacer height="10px"/>

                            <p:outputLabel value="#{occPermitApplicationBB.personRequirementDescription.get(1)}"/>

                            <p:spacer height="10px"/>

                            <p:outputLabel value="#{occPermitApplicationBB.personRequirementDescription.get(2)}"/>

                            <p:dataTable id="applicationPersonTable"
                                         widgetVar="datatable"
                                         rowIndexVar="rowIndex"
                                         var="applicationPerson" value="#{occPermitApplicationBB.attachedPersons}" 
                                         rowKey="#{applicationPerson.bundledPerson.personID}"
                                         editable="true">                                
                                <p:column headerText="Last Name">
                                    <p:cellEditor>
                                        <f:facet name="output"><h:outputText value="#{applicationPerson.bundledPerson.lastName}"/></f:facet>
                                        <f:facet name="input">
                                            <p:inputText value="#{applicationPerson.bundledPerson.lastName}"
                                                         onkeydown="PF('datatable').onKeyDown(event)"
                                                         onkeyup="PF('datatable').onKeyUp(event, #{rowIndex})"/>
                                        </f:facet>
                                    </p:cellEditor>
                                </p:column>

                                <p:column headerText="First Name">
                                    <p:cellEditor>
                                        <f:facet name="output"><h:outputText value="#{applicationPerson.bundledPerson.firstName}"/></f:facet>
                                        <f:facet name="input">
                                            <p:inputText value="#{applicationPerson.bundledPerson.firstName}"
                                                         onkeydown="PF('datatable').onKeyDown(event)"
                                                         onkeyup="PF('datatable').onKeyUp(event, #{rowIndex})"/>
                                        </f:facet>
                                    </p:cellEditor>
                                </p:column>

                                <p:column headerText="Person Type">
                                    <p:selectOneMenu value="#{applicationPerson.bundledPerson.personType}">
                                        <f:selectItems value="#{occPermitApplicationBB.optAndReqPersons}" var="type" itemLabel="#{type.label}" itemValue="#{type}"/>
                                    </p:selectOneMenu> 
                                </p:column>  

                                <p:column headerText="Edit?">
                                    <p:rowEditor/>
                                    <p:rowToggler/>
                                </p:column>

                                <p:column headerText="">
                                    <p:commandButton ajax="true" value="Set as applicant" 
                                                     action="#{occPermitApplicationBB.setApplicant(applicationPerson)}"
                                                     update="#{p:component('currentApplicantLabel')} #{p:component('currentContactLabel')}"
                                                     /> 
                                </p:column>

                                <p:column headerText="">
                                    <p:commandButton ajax="true" value="Set as preferred contact" 
                                                     action="#{occPermitApplicationBB.setContactPerson(applicationPerson)}"
                                                     update="#{p:component('currentContactLabel')}"
                                                     /> 
                                </p:column>


                                <p:column>
                                    <p:commandButton ajax="true" value="Remove" 
                                                     action="#{occPermitApplicationBB.removePersonFromApplication(applicationPerson)}"
                                                     update="#{p:component('applicationPersonTable')}"
                                                     /> 
                                </p:column>

                                <p:rowExpansion>

                                    <div class="outlinedBox">

                                        <p:outputLabel><b>Remember to hit the enter key when you finish filling out a box!</b></p:outputLabel>
                                        
                                        <h:panelGrid columns="4" cellpadding="10" footerClass="gridFooter"
                                                     columnClasses="gridTd, gridTd, gridTd, gridTd">
                                            <h:panelGroup>
                                                <h:outputText styleClass="bold" value="Phone (cell)" />
                                                <div class="rowExpansion">
                                                    <p:inputText value="#{applicationPerson.bundledPerson.phoneCell}"/>
                                                </div>
                                            </h:panelGroup>

                                            <h:panelGroup>
                                                <h:outputText styleClass="bold" value="Phone (home)" />
                                                <div class="rowExpansion">
                                                    <p:inputText value="#{applicationPerson.bundledPerson.phoneHome}"/>
                                                </div>
                                            </h:panelGroup>

                                            <h:panelGroup>
                                                <h:outputText styleClass="bold" value="Phone (work)" />
                                                <div class="rowExpansion">
                                                    <p:inputText value="#{applicationPerson.bundledPerson.phoneWork}"/>
                                                </div>
                                            </h:panelGroup>

                                            <h:panelGroup>
                                                <h:outputText styleClass="bold" value="Email" />
                                                <div class="rowExpansion">
                                                    <p:inputText value="#{applicationPerson.bundledPerson.email}"/>
                                                </div>
                                            </h:panelGroup>

                                            <p:spacer height="5px"/>

                                            <h:panelGroup>
                                                <h:outputText styleClass="bold" value="Street" />
                                                <div class="rowExpansion">
                                                    <p:inputText value="#{applicationPerson.bundledPerson.addressStreet}"/>
                                                </div>
                                            </h:panelGroup>

                                            <h:panelGroup>
                                                <h:outputText styleClass="bold" value="City" />
                                                <div class="rowExpansion">
                                                    <p:inputText value="#{applicationPerson.bundledPerson.addressCity}"/>
                                                </div>
                                            </h:panelGroup>

                                            <h:panelGroup>
                                                <h:outputText styleClass="bold" value="State" />
                                                <div class="rowExpansion">
                                                    <p:inputText value="#{applicationPerson.bundledPerson.addressState}"/>
                                                </div>
                                            </h:panelGroup>

                                            <h:panelGroup>
                                                <h:outputText styleClass="bold" value="Zip Code" />
                                                <div class="rowExpansion">
                                                    <p:inputText value="#{applicationPerson.bundledPerson.addressZip}"/>
                                                </div>
                                            </h:panelGroup>

                                            <p:spacer height="5px"/>

                                            <h:outputText styleClass="bold" value="If you have a separate mailing address, fill out the section below:"/>

                                            <h:panelGroup>
                                                <h:outputText styleClass="bold" value="Would you like to use a separate mailing address?" />
                                                <div class="rowExpansion">
                                                    <p:inputSwitch value="#{applicationPerson.bundledPerson.useSeparateMailingAddress}" onLabel="Yes" offLabel="No"/>
                                                </div>
                                            </h:panelGroup>

                                            <h:panelGroup>
                                                <h:outputText styleClass="bold" value="Street" />
                                                <div class="rowExpansion">
                                                    <p:inputText value="#{applicationPerson.bundledPerson.mailingAddressStreet}"/>
                                                </div>
                                            </h:panelGroup>

                                            <h:panelGroup>
                                                <h:outputText styleClass="bold" value="Address third line:" />
                                                <div class="rowExpansion">
                                                    <p:inputText value="#{applicationPerson.bundledPerson.mailingAddressThirdLine}"/>
                                                </div>
                                            </h:panelGroup>

                                            <h:panelGroup>
                                                <h:outputText styleClass="bold" value="City" />
                                                <div class="rowExpansion">
                                                    <p:inputText value="#{applicationPerson.bundledPerson.mailingAddressCity}"/>
                                                </div>
                                            </h:panelGroup>

                                            <h:panelGroup>
                                                <h:outputText styleClass="bold" value="State" />
                                                <div class="rowExpansion">
                                                    <p:inputText value="#{applicationPerson.bundledPerson.mailingAddressState}"/>
                                                </div>
                                            </h:panelGroup>

                                            <h:panelGroup>
                                                <h:outputText styleClass="bold" value="Zip Code" />
                                                <div class="rowExpansion">
                                                    <p:inputText value="#{applicationPerson.bundledPerson.mailingAddressZip}"/>
                                                </div>
                                            </h:panelGroup>


                                        </h:panelGrid>



                                    </div>

                                </p:rowExpansion>

                            </p:dataTable>

                            <script type="text/javascript">

                                $(function () {
                                    $.extend(PF("datatable"), {
                                        onKeyDown: function (e) {
                                            var key = e.which,
                                                    keyCode = $.ui.keyCode;

                                            if ((key === keyCode.ENTER || key === keyCode.NUMPAD_ENTER)) {
                                                e.preventDefault();
                                            }
                                        },

                                        onKeyUp: function (e, rowIndex) {
                                            var key = e.which,
                                                    keyCode = $.ui.keyCode;
                                            //.ui-row-editor-check .ui-icon-check .ui-c
                                            if ((key === keyCode.ENTER || key === keyCode.NUMPAD_ENTER)) {
                                                this.tbody
                                                        .find('.ui-row-editor .ui-icon-check')
                                                        .eq(rowIndex)
                                                        .click();
                                            }

                                            if (key === keyCode.ESCAPE) {
                                                this.tbody
                                                        .find('.ui-row-editor .ui-icon-close')
                                                        .eq(rowIndex)
                                                        .click();
                                            }
                                        }
                                    });
                                });

                            </script>
                            <p:spacer height="10px"/>

                            <h:outputText id ="currentApplicantLabel" value="Current Applicant: #{occPermitApplicationBB.applicantName}"/>

                            <p:spacer height="10px"/>

                            <h:outputText id ="currentContactLabel" value="Preferred Contact: #{occPermitApplicationBB.contactName}"/>

                            <p:spacer height="10px"/>
                            <p:commandButton update="applicationPersonTable" value="Add a new person" action="#{occPermitApplicationBB.addANewPerson}" />

                            <p:spacer height="10px"/>


                            <p:commandButton ajax="false" value="Review application"
                                             action="#{occPermitApplicationBB.reviewApplication}"/>

                        </h:form>

                    </div>
                </f:view>

            </ui:define>
        </ui:composition>
    </h:body>
</html>

