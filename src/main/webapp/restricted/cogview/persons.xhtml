<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">
    <h:head>
        <title>Persons</title>
    </h:head>
    <h:body>
        <ui:composition template="../navContainer_restricted.xhtml">
            <ui:define name="content">

                <f:view id="persons-view">
                    <div class="two-column-page-flex-container">
                        <div class="list-column-persons">
                            <h:form id="messages-left-form">
                                <h:messages id="persons-messages-global"
                                            globalOnly="true" showDetail="true" showSummary="true"
                                            warnClass="msgWarn" infoClass="msgInfo" fatalClass="msgFatal" errorClass="msgError">
                                </h:messages>
                            </h:form>

                            <h1 class="property-maroon">Persons</h1>
                            
                            <h:form id="start-new-person-form">
                                
                                <p:commandButton    id="new-person-cb"
                                                    ajax="true" action="#{personsBB.initiatePersonCreation}"
                                                    value="Create new Person"
                                                    disabled="!#{sessionBean.facesUser.keyCard.hasMuniStaffPermissions}"
                                                    icon="fa fa-child"/>
                            </h:form>
                            
                            
                            <h2>Search for persons</h2>


                            <h:form id="change-person-form">

                                <h:messages id="person-search-messages" globalOnly="true" showDetail="true" showSummary="true"
                                            warnClass="msgWarn" infoClass="msgInfo" fatalClass="msgFatal" errorClass="msgError">
                                </h:messages>


                                <h:panelGrid columns="2" cellpadding="10" footerClass="gridFooter"
                                             columnClasses="gridTd-solid-back, gridTd-solid-back">

                                    <h:panelGroup>
                                        <p:outputLabel for="formFirstName-person">
                                            <h:outputText value="First Name"/>
                                        </p:outputLabel>
                                        <p:inputText id="formFirstName-person" value="#{personsBB.searchParams.firstNameSS}" 
                                                     style="width: 200px;" tabindex="1" required="false" styleClass="inputText">
                                        </p:inputText>
                                        <h:message for="formFirstName-person" showDetail="true" showSummary="true" 
                                                   warnClass="msgWarn" infoClass="msgInfo" fatalClass="msgFatal" errorClass="msgError" />
                                    </h:panelGroup>

                                    <h:panelGroup id="lname-person-person">
                                        <p:outputLabel for="formLastName-person">
                                            <h:outputText value="Last Name"/>
                                        </p:outputLabel>
                                        <p:inputText id="formLastName-person" value="#{personsBB.searchParams.lastNameSS}" 
                                                     style="width: 200px;" tabindex="2" required="false" styleClass="inputText">
                                        </p:inputText>
                                        <h:message for="formLastName-person" showDetail="true" showSummary="true" 
                                                   warnClass="msgWarn" infoClass="msgInfo" fatalClass="msgFatal" errorClass="msgError" />
                                    </h:panelGroup>
                                </h:panelGrid>

                                <p:commandButton
                                    value="Search by name only" tabindex="3" 
                                    ajax="true" icon="fa fa-search"
                                    process=    "   @form
                                                    change-person-form:formFirstName-person
                                                    change-person-form:formLastName-person"
                                    actionListener="#{personsBB.searchForPersons}" 
                                    update=    ":search-params-form
                                                change-person-form:formFirstName-person
                                                change-person-form:formLastName-person
                                                change-person-form:personTable
                                                change-person-form:person-search-messages
                                                messages-left-form:persons-messages-global"/>
                                <hr />
                                
                                <p:commandButton    id="open-search-options-cb"
                                                    ajax="true" process="@none"
                                                    value="Advanced search options"
                                                    disabled="!#{sessionBean.facesUser.keyCard.hasMuniStaffPermissions}"
                                                    onclick="PF('search-params-dialog').show()"
                                                    icon="fa fa-gears"/>



                                <h2>Search Results in <h:outputText value="#{personsBB.searchParams.muni.muniName}" /></h2>
                                
                                <p:commandButton    id="load-history-cb"
                                                    actionListener="#{personsBB.loadPersonHistory}"
                                                    ajax="true" style="background-color: white;"
                                                    value="Load person history"
                                                    update="change-person-form:personTable
                                                    messages-left-form:persons-messages-global"
                                                    icon="fa fa-history"/>
                                <p:spacer height="2px"/>

                                <p:dataTable
                                    id="personTable"
                                    var="per"
                                    value="#{personsBB.personList}"
                                    rowKey="#{per.personID}"
                                    tableStyleClass="primeDataTable"
                                    rowExpandMode="single"
                                    expandedRow="false"
                                    filteredValue="#{personsBB.filteredPersonList}"
                                    widgetVar="personSelectListTable">
                                    <!--<p:ajax event="rowSelect" update="selectedRowLabel"/>-->

                                    <p:column width="4%">
                                        <f:facet name="header">
                                            <h:outputText value="ID" />
                                        </f:facet>
                                        <h:outputText value="#{per.personID}"/>
                                    </p:column>

                                    <p:column width="10%" sortBy="#{per.personType.label}">
                                        <f:facet name="header">
                                            <h:outputText value="Person Type" />
                                        </f:facet>
                                        <h:outputText value="#{per.personType.label}"/>
                                    </p:column>


                                    <p:column width="10%" sortBy="#{per.firstName}"
                                              filterBy="#{per.firstName}">
                                        <f:facet name="header">
                                            <h:outputText value="First" />
                                        </f:facet>
                                        <h:outputText value="#{per.firstName}"/>
                                    </p:column>

                                    <p:column width="10%" filterBy="#{per.lastName}"
                                              sortBy="#{per.lastName}">
                                        <f:facet name="header">
                                            <h:outputText value="Last" />
                                        </f:facet>
                                        <h:outputText value="#{per.lastName}"/>
                                    </p:column>

                                    <p:column   width="20%"
                                                sortBy="#{per.addressStreet}"
                                                filterBy="#{per.addressStreet}">
                                        <f:facet name="header">
                                            <h:outputText value="Address" />
                                        </f:facet>
                                        <h:outputText escape="false" value="#{per.addressStreet}"/>
                                        <p:spacer height="5px"/>
                                        <h:outputText value="#{per.addressCity}, #{per.addressState} #{per.addressZip}"/>
                                    </p:column>

                                    <p:column width="10%" >
                                        <f:facet name="header">
                                            <h:outputText value="View" />
                                        </f:facet>
                                        <p:commandButton actionListener="#{personsBB.selectPerson(per)}"
                                                         ajax="true" icon="fa fa-hand-o-right"
                                                         value="view"
                                                         update="selected-person-info-form:selected-person-info-ds"/>
                               
                                    </p:column>

                                    <p:rowExpansion>
                                    </p:rowExpansion>
                                </p:dataTable>
                            </h:form>
                        </div>

                        <div class="object-column">

                            <p:spacer height="6px;"/>

                            <h:form id="selected-person-info-form">

                                <p:dataScroller
                                    id="selected-person-info-ds"
                                    value="#{personsBB.selectedPerson}"
                                    var="p">


                                    <div class="outlinedBox">

                                        <h2><h:outputText value="#{p.firstName} #{p.lastName} (#{p.muni.muniName})"/>, Person ID:<h:outputText value="#{p.personID}"/> </h2>
                                        <h:panelGrid columns="2" cellpadding="10" footerClass="gridFooter"
                                                     columnClasses="gridTd, gridTd, gridTd, gridTd">
                                            <h:panelGroup>
                                                <h:outputLabel styleClass="bold" value="Person Type: "/>
                                                    <h:outputText value="#{p.personType.label}"/>
                                                
                                                <p:spacer height="5px"/>
                                                
                                                <h:outputLabel styleClass="bold" value="Job Title: "/>
                                                    <h:outputText value="#{p.jobTitle}"/>
                                                
                                                <p:spacer height="5px"/>
                                                
                                                <h:outputLabel styleClass="bold" value="Email: "/>
                                                    <h:outputText value="#{p.email}"/>
                                            </h:panelGroup>
                                            
                                            <h:panelGroup>
                                                <h:outputLabel styleClass="bold" value="Last Updated: "/>
                                                <h:outputText value="#{p.lastUpdatedString}"/>
                                            </h:panelGroup>

                                            <h:panelGroup>
                                                <h:outputLabel styleClass="bold" value="Address: "/>
                                                <p:spacer height="5px"/>
                                                    <h:outputText escape="false" value="#{p.addressStreet}"/>
                                                    <p:spacer height="5px"/>
                                                    <h:outputText value="#{p.addressCity}, #{p.addressState} #{p.addressZip}"/>
                                            </h:panelGroup>
                                            
                                            <h:panelGroup>
                                                <h:outputLabel styleClass="bold" value="Use separate mailing address?"/>
                                                <h:outputText value="#{p.useSeparateMailingAddress ? 'Yes':'No'}"/>
                                                <p:spacer height="5px"/>
                                                    <h:outputText escape="false" value="#{p.mailingAddressStreet}"/>
                                                    <p:spacer height="5px"/>
                                                    <h:outputText value="#{p.mailingAddressCity}, #{p.mailingAddressState} #{p.mailingAddressZip}"/>
                                            </h:panelGroup>

                                            <h:panelGroup>
                                                <h:outputLabel styleClass="bold" value="Under 18? "/>
                                                <h:outputText value="#{p.under18 ? 'Yes':'No'}"/>
                                                
                                                <p:spacer height="5px"/>
                                                
                                                <h:outputLabel styleClass="bold" value="Active? "/>
                                                <h:outputText value="#{p.active ? 'Yes':'No'}"/>
                                                
                                                <p:spacer height="5px"/>
                                                
                                                <h:outputLabel styleClass="bold" value="Composite last name? "/>
                                                <h:outputText value="#{p.compositeLastName? 'Yes':'No'}"/>
                                            </h:panelGroup>


                                            <h:panelGroup>
                                                <h:outputLabel styleClass="bold" value="Allowed to expire? "/>
                                                <h:outputText value="#{p.canExpire ? 'Yes':'No'}"/>
                                                <p:spacer height="5px"/>

                                                <h:outputLabel styleClass="bold" value="Expires: "/>
                                                <h:outputText value="#{p.expireString}"/>
                                                
                                                <p:spacer height="5px"/>
                                                <h:outputLabel styleClass="bold" value="Expiry Notes: "/>
                                                <div class="rowExpansion">
                                                    <h:outputText value="#{p.expiryNotes}"/>
                                                </div>
                                                
                                            </h:panelGroup>

                                            <h:panelGroup>
                                                <h:outputLabel styleClass="bold" value="Phone(h): "/>
                                                <h:outputText value="#{p.phoneHome}"/>
                                                <p:spacer height="5px"/>
                                                
                                                <h:outputLabel styleClass="bold" value="Phone(w): "/>
                                                <h:outputText value="#{p.phoneWork}"/>
                                                <p:spacer height="5px"/>
                                                
                                                <h:outputLabel styleClass="bold" value="Phone(m): "/>
                                                <h:outputText value="#{p.phoneCell}"/>
                                            </h:panelGroup>
                                            <h:panelGroup>
                                                <h:outputLabel styleClass="bold" value="Linked to user? "/>
                                                <h:outputText value="#{empty p.userLink ? 'No':'Yes'}"/>
                                                <p:spacer height="5px"/>
                                                
                                            </h:panelGroup>
                                                

                                            <f:facet name="footer">
                                                <hr />
                                                <h:outputLabel styleClass="bold" value="Person notes"/> 
                                                <p:spacer height="5px"/>
                                                <p:commandButton onclick="PF('person-note-dialog').show()" 
                                                             icon="fa fa-send"
                                                             value="create new note" 
                                                             styleClass="noFill" 
                                                             rendered="#{sessionBean.facesUser.keyCard.hasMuniReaderPermissions}" />
                                                <p:spacer height="15px"/>
                                                <div class="rowExpansion">
                                                    <h:outputText escape="false" value="#{p.notes}"/>
                                                </div>
                                            </f:facet>
                                        </h:panelGrid>
                                    </div>
                                    <p:commandButton value="update person" ajax="true"
                                                     icon="fa fa-edit"
                                                     action="#{personsBB.initiatePersonUpdate}"/>

                                </p:dataScroller>


                            </h:form>

                            
                            <h3>Associated properties</h3>
                            
                            
                                <p:dataTable
                                    id="propSearchTable"
                                    var="prop"
                                    value="#{propertyProfileBB.propList}"
                                    rowKey="#{prop.propertyID}"
                                    filteredValue="#{propertyProfileBB.filteredPropList}"
                                    tableStyleClass="primeDataTable"
                                    draggableRows="false" tabindex="6"
                                    >
                                    <p:column width="8%">
                                        <f:facet name="header">
                                            <h:outputText value="ID"/>
                                        </f:facet>
                                        <h:outputText value="#{prop.propertyID}" />
                                    </p:column>
                                    <p:column width="15%">
                                        <f:facet name="header">
                                            <h:outputText value="Address"/>
                                        </f:facet>
                                        <h:outputText value="#{prop.address}" />
                                    </p:column>

                                    <p:column width="10%">
                                        <f:facet name="header">
                                            <h:outputText value="Muni" />
                                        </f:facet>
                                        <h:outputText value="#{prop.muni.muniName}"/>
                                    </p:column>

                                    <p:column width="12%">
                                        <f:facet name="header">
                                            <h:outputText value="Use Type"/>
                                        </f:facet>
                                        <h:outputText value="#{prop.propertyUseType}" />
                                    </p:column>

                                    <p:column width="5%">
                                        <f:facet name="header">
                                            <h:outputText value=""/>
                                        </f:facet>
                                        <p:commandButton icon="fa fa-hand-o-right"
                                                         action="#{propertyProfileBB.manageProperty(prop)}" 
                                                         ajax="true"/>
                                    </p:column>
                                </p:dataTable>
                            

                        </div>
                    </div>

                    <p:dialog   height="650" width="700"
                                widgetVar="search-params-dialog"
                                closable="true" 
                                rendered="#{sessionBean.facesUser.keyCard.hasMuniReaderPermissions}">

                        <h:form id="search-params-form">
                            <h3>Advanced Person search options</h3>
                            
                            <p>Use the check boxes in the left column to control which of the search values
                            in the right will be used in constraining your search.</p>
                            
                            <p>An unchecked box no the left means "Don't consider this factor at all, regardless of the setting of the control.</p>
                            
                             <h:panelGrid columns="2" cellpadding="10" footerClass="gridFooter"
                                 columnClasses="gridTd-solid-back, gridTd-solid-back">
                                              

                            <h:panelGroup>
                                <p:outputLabel id="filter-by-fname-ol" for="filter-by-fname-cb" value="Filter by first name?"/>
                                <p:spacer height="5px"/>
                                <p:selectBooleanCheckbox id="filter-by-fname-cb" value="#{personsBB.searchParams.filterByFirstName}" />
                            </h:panelGroup>

                           

                            <h:panelGroup>
                                <p:outputLabel id="filter-by-lname-ol" for="filter-by-lname-cb" value="Filter by last name?"/>
                                <p:spacer height="5px"/>
                                <p:selectBooleanCheckbox id="filter-by-lname-cb" value="#{personsBB.searchParams.filterByLastName}" />
                            </h:panelGroup>

                           

                            <h:panelGroup>
                                <p:outputLabel for="muniSelectMenu-person">
                                    <h:outputText value="Municipality:"/>
                                </p:outputLabel>
                                <p:spacer height="5px"/>

                                <p:selectOneMenu id="muniSelectMenu-person" 
                                                 tabindex="1" 
                                                 value="#{personsBB.searchParams.muni}">
                                    <f:converter converterId="muniConverter"/>
                                    <f:selectItem itemLabel="select muni..." noSelectionOption="true"  itemDisabled="true"/>
                                    <f:selectItems id="muniNameList" value="#{sessionBean.facesUser.authMunis}" var="m" itemValue="#{m}" itemLabel="#{m.muniName}" />
                                </p:selectOneMenu>
                            </h:panelGroup>

                            <h:panelGroup>
                                <p:outputLabel id="filter-by-personid-ol" for="filter-by-personid-cb" value="Filter by person ID?"/>
                                <p:spacer height="5px"/>
                                <p:selectBooleanCheckbox id="filter-by-personid-cb" value="#{personsBB.searchParams.filterByObjectID}" />
                            </h:panelGroup>



                            <h:panelGroup id="personID">
                                <p:outputLabel for="formPersonID">
                                    <h:outputText value="Person ID number"/>
                                </p:outputLabel>
                                <p:inputText id="formPersonID" value="#{personsBB.searchParams.objectID}" 
                                             style="width: 25%;" tabindex="3" required="false" styleClass="inputText"/>
                                <h:message for="formPersonID" showDetail="false" showSummary="true" 
                                           warnClass="msgWarn" infoClass="msgInfo" fatalClass="msgFatal" errorClass="msgError" />

                            </h:panelGroup>
                            </h:panelGrid>

                            <p:commandButton ajax="true" value="Cancel" icon="fa fa-stop" immediate="true"
                                             onclick="PF('search-params-dialog').hide()"/>

                            <p:commandButton ajax="true" value="Conduct search"  icon="fa fa-search"
                                             process="  @form
                                                        change-person-form:formFirstName-person
                                                        change-person-form:formLastName-person"
                                             actionListener="#{personsBB.searchForPersons}"
                                             rendered="#{sessionBean.facesUser.keyCard.hasMuniStaffPermissions}"
                                             update="   change-person-form:personTable
                                                        messages-left-form:persons-messages-global"
                                             oncomplete="PF('search-params-dialog').hide()"/>

                        </h:form>
                    </p:dialog>

                    <p:dialog      height="650" width="1200"
                                   widgetVar="update-person-dialog"
                                   closable="true" 
                                   rendered="#{sessionBean.facesUser.keyCard.hasMuniStaffPermissions}">

                    </p:dialog>
                    
                        <p:confirmDialog message="Attach note to Person" 
                                         severity="alert" widgetVar="person-note-dialog"
                                         closable="true" responsive="true"
                                         rendered="#{sessionBean.facesUser.keyCard.hasMuniStaffPermissions}">

                            <h:form id="person-note-form">
                                <h:outputLabel for="note-ita" value="Note text"/>
                                <p:spacer height="15px"/>
                                <p:inputTextarea id="note-ita" style="width: 300px; height: 200px;" value="#{personsBB.notesToAppend}" tabindex="1"/>
                                <p:spacer height="15px"/>
                                <h:outputText escape="false" value="The above text, your name, and a timestamp will be attached to "/> 
                                <h:outputText value="#{p.firstName} #{p.lastName} (#{p.muni.muniName})"/>, Person ID:<h:outputText value="#{p.personID}"/>

                                <p:spacer height="15px"/>
                                <p:commandButton ajax="true" tabindex="2"
                                                 value="Cancel" icon="fa fa-stop" 
                                                 onclick="PF('person-note-dialog').hide()"/>
                                <p:commandButton    ajax="true" actionListener="#{personsBB.attachNoteToPerson}" tabindex="3"
                                                    value="Submit" icon="fa fa-link" oncomplete="PF('person-note-dialog').hide()"
                                                    rendered="#{sessionBean.facesUser.keyCard.hasMuniStaffPermissions}"
                                                    update="    selected-person-info-form:selected-person-info-ds
                                                                messages-left-form:persons-messages-global"/>
                            </h:form>
                        </p:confirmDialog>
                </f:view>
            </ui:define>
        </ui:composition>
    </h:body>
</html>

